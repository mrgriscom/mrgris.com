---
kind: article
created_at: 2013-10-22
title: "Global Entry, or: How I Opened My Front Door via SMS"
tags:
---

fresh from the closing,
i entered the condo after closing and thought 'this my space mine'.
i could customize it as i wish.
what to do? home automation?
the first gear starting spinning when i saw i could buzz people in to the building.
i knew i would want to control this from more than just physically pressing the button.

<div><a href="https://picasaweb.google.com/lh/photo/U2CckbwmZV-V-vB7vSQBzdMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-a7iMyVkGw1A/U-19Qcpy-mI/AAAAAAAAFeE/A3RCfTiYk5c/s400/sIMG_3018.JPG" /></a></div>

(FYI, this kind of remotely controlled door lock is called an ["electric strike"](http://en.wikipedia.org/wiki/Electric_strike))

the first step to doing anything was gaining access to the 'door' circuit and get useful leads that could be wired into whatever would remotely trigger it.

talking the apartment panel off didn't reveal much besides satisfying some curiosity.
but yes, shorting two ends of the 'door' button together would indeed unlock the front door.

<div><a href="https://picasaweb.google.com/lh/photo/2-dNoiVuupXVudRiJ8B_R9MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-L_GdzDOPc6Y/U-19QEgHcyI/AAAAAAAAFeE/-vkxnR9drdM/s400/sIMG_3019.JPG" /></a></div>

but how to trigger it?
hooking up there specifically would be difficult as it was just the panel and the wall.
it would be difficult to hide the wires cleanly, and a messy setup would not fly, especially as the first thing you'd see entering the unit.
more important than aesthetics is safety.
a relay would require some low-voltage DC power, and putting that kind of wiring inside a wall especially with the necessary transformer (and waste heat) is not something i was comfortable with.

but then i realized: those wires go somewhere.
to a central control console in the basement, where access is much easier.
for a while i debated how exactly to 'tap in' to my wire (and determine which one corresponded to my unit!)

<div><a href="https://picasaweb.google.com/lh/photo/4nfmQGQTyaujAD27sCIqLdMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh6.googleusercontent.com/-vCj1GsZkJxQ/U-19RQbngSI/AAAAAAAAFeE/vvxY2Hg1EOw/s400/sIMG_3026.JPG" /></a></div>

before i realized i could just access the terminals on the console itself.

<div><a href="https://picasaweb.google.com/lh/photo/_pquxZPhPbofDR3X_vEHl9MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh3.googleusercontent.com/-McbBXUydxdk/U-19QVYUD1I/AAAAAAAAFeE/sL1X3T4XRkY/s400/sIMG_3024.JPG" /></a></div>

all the door buttons end up at two adjacent terminals.
when shorted across those terminals, door opens.
so instead just wire up a second set to those terminals to use for my purposes.

<div><a href="https://picasaweb.google.com/lh/photo/OUDsRZkVSII3c0MZ-d0vbNMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh3.googleusercontent.com/-gJl1S6kmZLc/U-19RZfIJYI/AAAAAAAAFeE/EQP4WGRRT34/s400/sIMG_3025.JPG" /></a></div>

Step 1: Remote Control
======================

use a radio-activated relay (like for a garage door opener)

[the relay](http://www.lightobject.com/Multi-function-1CH-RF-with-waterproof-remote-control-P702.aspx)

funnily, your choice of relay ends up more determined by the remote. (size + aesthetics).

<div><a href="https://picasaweb.google.com/lh/photo/qM-hDUntB-IJOm3wjy6p69MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-xydzvGZZouQ/U-19UHg_PlI/AAAAAAAAFeE/UMQ40c413v4/s400/sremote.jpg" /></a></div>

<div><a href="https://picasaweb.google.com/lh/photo/7tlwJQszgHkqiPKKnp0lONMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-AMvSzCCvPHI/U-19Ri6Nv5I/AAAAAAAAFeE/nSXZdGxPCSo/s400/sIMG_3030.JPG" /></a></div>

Step 2: Internet Control!
=====================================

Obviously.

i was already immensely pleased with radio control, but it was mostly a novelty.
i didn't have to fish my key (though still for the deadbolt door to my apt.
(arduino lockitron tbd).
i could do more interesting things when i didn't have to be within 100ft.

use cases:

* i've locked myself out (if i don't have my keys, i probably don't have the remote either)
* melissa and i are away and we have a friend crashing at our house. avoid complicated keys handoff
* having a party and don't want to man the door buzzer for 3 hours

same issue: need access to the wires. raspberry pi in basement?

OR, have something that triggers one of your wireless remotes, that triggers the relay you already have hooked up. (credit melissa for bright idea)

<div><a href="https://picasaweb.google.com/lh/photo/qC891AdTJyt2mTaU1eca6NMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh3.googleusercontent.com/-h6H4ZTJhP6w/U-19STeUBnI/AAAAAAAAFeE/k4T_Lk2taYQ/s400/sIMG_3038.JPG" /></a></div>

security model. two kinds of access: resident and guest. resident access is perpetual. guest access is short-lived.


i didn't want to have to deal with whitelisting emails or phone numbers. that would get too cumbersome. i'd rather have a code and anyone with that code can use it. handles last-minute invitees to the party or someone's phone being dead. the short lifespan of the individual codes mitigates the risk. long-term/perpetual access is tied to identity. you have to be verified by your login each time.

webapp gets signal (validates it), runs a command that triggers a relay to send the radio signal. that triggers the relay to open the door.

usb relay -- product literally does not exist in the us. so instead using an arduino. which feels ridiculous. but it is nice because it ensured once the relay goes on it will always turn off too.

<div><a href="https://picasaweb.google.com/lh/photo/2WYsKxmPks5Gr-MN9hIuT9MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh4.googleusercontent.com/-vTZoYKdJxR4/U-19S7dvz-I/AAAAAAAAFeE/IC2oC50ZGnI/s400/sIMG_3040.JPG" /></a></div>

server lives in cloud, because self-signed certs are bad. twilio won't accept them. server sends command to house server via ssh. piggybacked session.

<style>

#flowchart {
  text-align: center;
  font-family: sans-serif;
  font-size: 75%;
  float: left;
  margin-right: 2em;
}

.box {
  float: right;
  width: 10em;
  padding: .4em;
  border-radius: .3em;
  margin-bottom: 1em;
  white-space: nowrap;
}

.state {
  clear: both;
  border: 1px solid black;
}

.input {
  border: 1px solid #aaa;
  position: relative;
  width: 7em;
}

.link {
  float: right;
  padding: .4em;
  display: table-cell;
}

.link span {
  font-style: italic;
  font-size: 80%;
  color: #888;
  background-color: #eef;
  border-radius: 50%;
  display: inline-block;
}

.hlink {
  margin-left: .3em;
  margin-right: 0;
}

.vlink {
  clear: both;
  width: 10em;
  margin-top: -1em;
}

.vlink span {
  width: 8em;
}

.terminal {
  background-color: #fcc;
}
.nonterm {
	position: relative;
}
.nonterm:after, .nonterm:before {
	top: 100%;
	left: 50%;
	border: solid transparent;
	content: " ";
	height: 0;
	width: 0;
	position: absolute;
	pointer-events: none;
}

.nonterm:after {
	border-color: rgba(255, 255, 255, 0);
	border-top-color: #ffffff;
	border-width: 7px;
	margin-left: -7px;
}
.nonterm:before {
	border-color: rgba(0, 0, 0, 0);
	border-top-color: #000000;
	border-width: 8px;
	margin-left: -8px;
}

.input:after, .input:before {
	left: 100%;
	top: 50%;
	border: solid transparent;
	content: " ";
	height: 0;
	width: 0;
	position: absolute;
	pointer-events: none;
}
.input:after {
	border-color: rgba(255, 255, 255, 0);
	border-left-color: #ffffff;
	border-width: 6px;
	margin-top: -6px;
}
.input:before {
	border-color: rgba(0, 0, 0, 0);
	border-left-color: #aaa;
	border-width: 7px;
	margin-top: -7px;
}

</style>

<div id="flowchart">
  <div>
    <div class="box state nonterm">twilio gateway</div>
    <div class="link hlink"><span>SMS</span></div>
    <div class="box input">send SMS</div>
    <div class="link vlink"><span>SMS payload via HTTPS</span></div>
  </div>
  <div>
    <div class="box state nonterm">public server</div>
    <div class="link hlink"><span>HTTPS POST</span></div>
    <div class="box input">visit URL</div>
    <div class="link vlink"><span>open command via ssh</span></div>
  </div>
  <div>
    <div class="box state nonterm">on-premises server</div>
    <div class="link vlink"><span>relay trigger command via serial USB</span></div>
  </div>
  <div>
    <div class="box state nonterm">arduino controller</div>
    <div class="link vlink"><span>5V on/off signal</span></div>
  </div>
  <div>
    <div class="box state nonterm">relay board</div>
    <div class="link vlink"><span>momentary switch</span></div>
  </div>
  <div>
    <div class="box state nonterm">sacrificed remote</div>
    <div class="link vlink"><span>RF signal</span></div>
  </div>
  <div>
    <div class="box state nonterm">RF relay</div>
    <div class="link hlink"><span>RF signal</span></div>
    <div class="box input">click remote</div>
    <div class="link vlink"><span>momentary switch</span></div>
  </div>
  <div>
    <div class="box state nonterm">door console</div>
    <div class="link hlink"><span>momentary switch</span></div>
    <div class="box input">door buzzer</div>
    <div class="link vlink"><span>lock signal</span></div>
  </div>
  <div>
    <div class="box state terminal">front door!</div>
  </div>
  <div style="clear: both;"></div>
</div>

when you put it all together, it looks a bit ridiculous, rube-goldbergian:

a bit crazy to think of the thousands of miles and numerous systems my 'open' signal travels/passes through when i'm standing right in front of the door.

<div style="clear: both;"></div>

<div><a href="https://picasaweb.google.com/lh/photo/JaO6ly6QVHld4dzt2ZlJuNMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh4.googleusercontent.com/-_nFxoYPTH7I/U-19TrDorOI/AAAAAAAAFeE/u9zPglHtp_s/s400/sIMG_3041.JPG" /></a></div>

Security
========

as this thing grants physical access to your premises, security is important.

rf security
--------------

radio: 1527 "learning code" buzzers. 20-bit, randomly generated code.

not a "rolling code" buzzer. as i understand this would not work well for mutliple buzzers that are used with greatly differing frequency.

website
-------

ssl access (hides codes, tokens, and cookies)
url door open via signed id cookie or uuid token
uuid tokens and sms codes are short-lived
twilio access is via ssl, and requests are authenticated for origin (brute-forcing the sms codes would be relatively easy otherwise)
google authentication for admin panel

physical
--------

command is executed via ssh

code not up, but i should probably put money where my mouth is

