---
kind: article
created_at: 2013-11-21
title: "Global Entry, or: How I Opened My Front Door with an SMS"
tags:
---

<style>

.right {
  clear: both;
  float: right;
  margin-left: 15px;
  margin-bottom: 15px;
  text-align: right;
}

.left {
  clear: both;
  float: left;
  margin-right: 15px;
  margin-bottom: 15px;
}

</style>

Fresh from the closing, I paced around my newly purchased, completely bare condo.
It was literally a blank canvas.
"This space is _mine_," I thought to myself, "I can customize it as I wish."

<div class="right"><a href="https://picasaweb.google.com/lh/photo/U2CckbwmZV-V-vB7vSQBzdMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-a7iMyVkGw1A/U-19Qcpy-mI/AAAAAAAAFeE/A3RCfTiYk5c/s400/sIMG_3018.JPG" /></a></div>

But what to do?
The first gears started spinning when I saw I could buzz people in to the building.
I knew I would want to control this capability by more than having to physically press the button.
(FYI, this kind of door system is called an ["electric strike"](http://en.wikipedia.org/wiki/Electric_strike))

<div style="clear: both;"></div>

Tapping In
==========

<div class="left"><a href="https://picasaweb.google.com/lh/photo/2-dNoiVuupXVudRiJ8B_R9MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-L_GdzDOPc6Y/U-19QEgHcyI/AAAAAAAAFeE/-vkxnR9drdM/s400/sIMG_3019.JPG" /></a></div>

The absolute first step before I could do anything else at all would be to tap into the 'door' circuit.
I needed to get useful leads out that could be wired into some alternate system (TBD) that would trigger the buzzing-in.

Taking off the panel in the apartment didn't reveal much except for satisfying some curiosity.
But yes, shorting the two ends of the 'door' button did indeed unlock the front door.

But how would I get my leads?
Hooking in here at this point would be tricky; it was just panel and wall.
It would be difficult to hide any wires cleanly, let alone any other equipment I would need; a messy setup would not fly, especially as the first thing you see when entering the apartment.
But more important than aesthetics is safety.
Whatever controlled the door would have to be powered, and putting that kind of wiring inside a wall -- particularly a DC transformer and associated waste heat -- was not something I was comfortable with.

<div class="right">
<a href="https://picasaweb.google.com/lh/photo/4nfmQGQTyaujAD27sCIqLdMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh6.googleusercontent.com/-vCj1GsZkJxQ/U-19RQbngSI/AAAAAAAAFeE/vvxY2Hg1EOw/s400/sIMG_3026.JPG" /></a>
<div class="aside">yikes</div>
</div>

But then I realized: those wires go somewhere.
They all snake through the basement to terminate at a central console.
Access down there would be much easier.

For a while I debated how exactly to tap in to the wires down here, and even how to determine which wire was mine, lest I screw up somebody elses buzzer!

But then came my second realization: all these wires go to the same place.
The central console would provide the most straightforward access.

<div style="clear: both;"></div>
<div class="left"><a href="https://picasaweb.google.com/lh/photo/_pquxZPhPbofDR3X_vEHl9MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh3.googleusercontent.com/-McbBXUydxdk/U-19QVYUD1I/AAAAAAAAFeE/sL1X3T4XRkY/s400/sIMG_3024.JPG" /></a></div>

The entire network of buzzers in the building reduces down to these two adjacent terminals.
Just like upstairs, shorting across them unlocks the front door.

<div style="clear: both;"></div>
<div class="right"><a href="https://picasaweb.google.com/lh/photo/OUDsRZkVSII3c0MZ-d0vbNMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh3.googleusercontent.com/-gJl1S6kmZLc/U-19RZfIJYI/AAAAAAAAFeE/EQP4WGRRT34/s400/sIMG_3025.JPG" /></a></div>

So I would wire in a parallel set of leads for my own use.

This was perhaps the most nerve-wracking portion of the project.
For the few moments this step took, buzzer access was out of service for the entire building.


Phase I: Remote Control
=======================

I had the necessary electrical access.
I now needed something to take advantage of it.

<div class="right"><a href="https://picasaweb.google.com/lh/photo/qM-hDUntB-IJOm3wjy6p69MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-xydzvGZZouQ/U-19UHg_PlI/AAAAAAAAFeE/UMQ40c413v4/s400/sremote.jpg" /></a></div>

Trying to replicate the keyless entry fobs like you'd have for your car seemed like a good proof-of-concept project.

This led to investigating radio-activated relays (similar to a garage door opener) and tiny keychain remote controls.
Funnily enough, [your choice of relay](http://www.lightobject.com/Multi-function-1CH-RF-with-waterproof-remote-control-P702.aspx) ends up more than anything else being determined by your preference for the form factor of the remote that comes with it.

<div style="clear: both;"></div>
<div>
<a href="https://picasaweb.google.com/lh/photo/7tlwJQszgHkqiPKKnp0lONMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-AMvSzCCvPHI/U-19Ri6Nv5I/AAAAAAAAFeE/nSXZdGxPCSo/s400/sIMG_3030.JPG" /></a>
<div class="aside">all hooked up</div>
</div>


Phase II: Internet Control
===========================

(obviously)

I was already immensely pleased with the radio control, but it was mostly a novelty.
Although it did save me from fishing out a key to get into the building, I still needed one to get into my apartment (no DIY [Lockitron](https://lockitron.com) just yet).
I could do more interesting things when I didn't have to be within <span style="font-family: serif;">50&#x2032;</span>.

More interesting things:

* I've locked myself out (if I don't have my keys, I definitely don't have the remote either).
* Melissa and I need to let someone in to check on something while we're away. Or, we have guests staying and wanted to avoid complicated keys hand-off.
* We're throwing a party and I don't want to man the door buzzer for three hours.
{: style="margin-bottom: 2.4em;"}

Hardware
--------

The control device presented the same issue as before: it needed access to the physical circuit.
Install a Raspberry Pi in tandem with the RF relay?
I was not thrilled with the prospect of sysadmining a glorified switch-flipper in the basement on the fringe of my wifi range.

<div class="right">
<a href="https://picasaweb.google.com/lh/photo/qC891AdTJyt2mTaU1eca6NMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh3.googleusercontent.com/-h6H4ZTJhP6w/U-19STeUBnI/AAAAAAAAFeE/k4T_Lk2taYQ/s400/sIMG_3038.JPG" /></a>
<div class="aside" style="width: 400px;">a sacrificed remote with leads wired in place of the push button; wires wrapped around the PCB for strain relief</div>
</div>

...***or***, wire up something that would trigger one of the wireless remotes, that in turn triggers the relay you've already wired up in the basement (credit Melissa for this brilliant idea).

To trigger the remote, I needed another relay, ideally controlled by USB.
Apparently such a product literally does not exist in the United States.
So instead I used an Arduino to control the relay while taking commands over USB, which feels utterly ridiculous.

<div style="clear: both;"></div>
<div class="left">
<a href="https://picasaweb.google.com/lh/photo/2WYsKxmPks5Gr-MN9hIuT9MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh4.googleusercontent.com/-vTZoYKdJxR4/U-19S7dvz-I/AAAAAAAAFeE/IC2oC50ZGnI/s400/sIMG_3040.JPG" /></a>
<div class="aside">completed in-apartment setup</div>
</div>

There was one nice side-effect, though.
My one main fear was that somehow the system would glitch and keep buzzing the door open perpetually.
The buzzer does not actually work like an on/off light switch.
Rather, you need a momentary press: on, then off, to send a signal to the control console.
If the 'on' signal were sent but the 'off' never was, there would be a big problem.

By having all the relay logic on the Arduino, I could be nearly certain that an 'on' would always be followed by an 'off', excepting loss of power, which would de-activate the relay anyway.

Software
--------

With the hardware taken care of, I had to figure out how to grant and manage access.
There are really two kinds of access: *resident* and *guest*.

Resident access is persistent.
Guest access is short-lived.
Guests are granted 'leases' for a particular entry purpose (visit, party, cat-sitting, etc.) and period of validity with a defined start and end time.
Each lease has a unique URL and numeric SMS code that when visited or messaged, opens the door.

I did not want to have to deal with whitelisting email addresses or phone numbers for guest access.
It would be too cumbersome and adversely affect the usability of my desired use cases.
For example, an out-of-town guest's phone might be dead.
Or the party invitation gets passed around to some last-minute invitees not originally on the list.
It is nice if people can still gain access from other than their usual device.

This means the lease URL and SMS code are **bearer tokens**.
Anyone in possession of them can gain access.
The short lifespan of each individual lease mitigates such a risk.

Residential access is handled differently.
The security risks are greater and usability is less of a concern.
The only residential use case is locking yourself out; day-to-day access would be via remote instead.
Therefore, residential access requires positive authentication every time.
In practice, this is outsourced to Google's sign-in API.
Residents authenticate with their Google account, and if it corresponds to a registered resident, access is granted.

Architecture
------------

The main app lives in the cloud (hosted on this very server).
It receives access requests directly via URL, or from Twilio upon the receipt of an incoming SMS.
The app validates the request, and if valid, the command is sent to open the door.

The cloud server cannot command the Arduino directly, as they must be connected by USB.
So instead, the command is sent through our apartment media server, which is physically connected to the Arduino.

<div class="right">
<a href="https://picasaweb.google.com/lh/photo/JaO6ly6QVHld4dzt2ZlJuNMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh4.googleusercontent.com/-_nFxoYPTH7I/U-19TrDorOI/AAAAAAAAFeE/u9zPglHtp_s/s400/sIMG_3041.JPG" /></a>
<div class="aside">all tucked in</div>
</div>

I actually would have preferred that the entire system be hosted on that one server, but there was a complication.
In order for the communications from Twilio to have maximum security, Twilio must verify the SSL certificate of my web app before speaking to it.
My home server does not have an SSL certificate, and you can't verify a self-signed cert.
Rather than acquire one solely for my home server to host this one thing (which might require, like, _paying actual money_), I'd rather just use my public server, which already has one.

Thus, the divison of responsibilites: my public server receives and validates the requests, and my home server executes them.

The bridge the gap, the public server executes a command remotely on the physical server via ssh tunnel.
In order to shave off precious seconds and make the system as responsive as possible, an ssh session is actually kept open between the two computers at all times.
The ephemeral session to execute the command uses the "connection sharing" feature of ssh, which allows it piggyback over the already-open session, and avoid all handshaking/authentication overhead.

But then it turns out the Arduino has a two-second delays before it will accept serial commands.
Balls.


The Big Picture
================
{: style="margin-bottom: 1.2em;"}

<style>

#flowchart {
  text-align: center;
  font-family: sans-serif;
  font-size: 75%;
  float: left;
  margin-right: 2em;
}

.box {
  float: right;
  width: 10em;
  padding: .4em;
  border-radius: .3em;
  margin-bottom: 1em;
  white-space: nowrap;
}

.state {
  clear: both;
  border: 1px solid black;
}

.input {
  border: 1px solid #aaa;
  position: relative;
  width: 7em;
}

.link {
  float: right;
  padding: .4em;
  display: table-cell;
}

.link span {
  font-style: italic;
  font-size: 80%;
  color: #888;
  background-color: #eef;
  border-radius: 50%;
  display: inline-block;
}

.hlink {
  margin-left: .3em;
  margin-right: 0;
}

.vlink {
  clear: both;
  width: 10em;
  margin-top: -1em;
}

.vlink span {
  width: 8em;
}

.terminal {
  background-color: #fcc;
}
.nonterm {
	position: relative;
}
.nonterm:after, .nonterm:before {
	top: 100%;
	left: 50%;
	border: solid transparent;
	content: " ";
	height: 0;
	width: 0;
	position: absolute;
	pointer-events: none;
}

.nonterm:after {
	border-color: rgba(255, 255, 255, 0);
	border-top-color: #ffffff;
	border-width: 7px;
	margin-left: -7px;
}
.nonterm:before {
	border-color: rgba(0, 0, 0, 0);
	border-top-color: #000000;
	border-width: 8px;
	margin-left: -8px;
}

.input:after, .input:before {
	left: 100%;
	top: 50%;
	border: solid transparent;
	content: " ";
	height: 0;
	width: 0;
	position: absolute;
	pointer-events: none;
}
.input:after {
	border-color: rgba(255, 255, 255, 0);
	border-left-color: #ffffff;
	border-width: 6px;
	margin-top: -6px;
}
.input:before {
	border-color: rgba(0, 0, 0, 0);
	border-left-color: #aaa;
	border-width: 7px;
	margin-top: -7px;
}

</style>

<div id="flowchart">
  <div>
    <div class="box state nonterm">twilio gateway</div>
    <div class="link hlink"><span>SMS</span></div>
    <div class="box input">send SMS</div>
    <div class="link vlink"><span>SMS payload via HTTPS</span></div>
  </div>
  <div>
    <div class="box state nonterm">public server</div>
    <div class="link hlink"><span>HTTPS POST</span></div>
    <div class="box input">visit URL</div>
    <div class="link vlink"><span>open command via ssh</span></div>
  </div>
  <div>
    <div class="box state nonterm">on-premises server</div>
    <div class="link vlink"><span>relay trigger command via serial USB</span></div>
  </div>
  <div>
    <div class="box state nonterm">arduino controller</div>
    <div class="link vlink"><span>5V on/off signal</span></div>
  </div>
  <div>
    <div class="box state nonterm">relay board</div>
    <div class="link vlink"><span>momentary switch</span></div>
  </div>
  <div>
    <div class="box state nonterm">sacrificed remote</div>
    <div class="link vlink"><span>RF signal</span></div>
  </div>
  <div>
    <div class="box state nonterm">RF relay</div>
    <div class="link hlink"><span>RF signal</span></div>
    <div class="box input">click remote</div>
    <div class="link vlink"><span>momentary switch</span></div>
  </div>
  <div>
    <div class="box state nonterm">door console</div>
    <div class="link hlink"><span>momentary switch</span></div>
    <div class="box input">door buzzer</div>
    <div class="link vlink"><span>lock signal</span></div>
  </div>
  <div>
    <div class="box state terminal">front door!</div>
  </div>
  <div style="clear: both;"></div>
</div>

When you put it all together, it all starts to look like a bit of rube-goldbergian ridiculousness.
But actually the very clear separation of parts contributes to the overall reliability of the system.

Nevertheless, it's crazy to think of the many thousands of miles travelled and numerous systems passed through when I tap a screen while standing right in front of the door.

Security
========

As this thing grants physical access to your premises, security considerations are paramount.

RF Security
-----------

Garage door remotes have gone through several evolutions in technology.
The first generation were "fixed code" remotes -- an 8--12-bit code that you set manually.
This yielded ~250--4,000 possible codes; it was easy to try them all.
These were not very secure.

The next generation, which this system uses, are called "learning code", with randomly generated codes around 20 bits long (one million combinations).
Remotes can 'learn' the code from the base station, thus making the longer codes feasible.
Learning code remotes are less vulnerable to brute-forcing (guessing all combinations), but are still vulnerable to snooping, since the code never changes.

Beyond learning code is "rolling code", in which the transmitted code changes every time.
While more secure than learning code, they are also more complex to manage since the remote and base station can get out of sync regarding what code they're expecting next.
This problem becomes exacerbated in deployments with large numbers of remotes and/or remotes that are used with greatly differing frequency.
(One problem is that these considerations, while surmountable, are usually just not well documented.)

The risk of snooping the learning code remotes is the one part of this system that relies on security by obscurity.
People simply aren't expecting garage door openers to open things that aren't garage doors.
I also live in a neighborhood with few garages, and the few that exist are detached and small; they are not entry points to houses nor likely to store valuables, assuming they even have openers.
The odds of roving bands of RF-scanning malcontents are very small.

Digital Security
----------------

All communications are encrypted and authenticated.

All access to the website is forced to use HTTPS.
This protects the sensitive bearer tokens from snooping.

Furthermore, incoming SMSes are authenticated to make sure they actually come from Twilio.
Otherwise an attacker could pretend to be Twilio and guess all possible SMS codes (only 5--6 digits) easily.

In the event that a bearer token is compromised, they are typically short-lived, and must have an expiration date.

Residential and admin access (to create new guest leases) requires positive authentication, and relies on Google security infrastructure to do so.
Once logged in, the session token is stored in a signed and secure cookie, invulnerable to sniffing and spoofing.

The remote command between the cloud and physical server is secured via ssh; it cannot be run unauthorized.

So secure.

Obscurity
---------

I haven't made the code public, though I suppose I should put my money where my mouth is...
