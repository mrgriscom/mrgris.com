---
kind: article
created_at: 2013-10-22
title: "Global Entry, or: How I Opened My Front Door via SMS"
tags:
---

<style>

.right {
  clear: both;
  float: right;
  margin-left: 15px;
  margin-bottom: 15px;
  text-align: right;
}

.left {
  clear: both;
  float: left;
  margin-right: 15px;
  margin-bottom: 15px;
}

</style>

Fresh from the closing, I paced around my newly purchased, completely bare condo.
It was literally a blank canvas.
"This space is _mine_," I thought to myself, "I can customize it as I wish."

<div class="right"><a href="https://picasaweb.google.com/lh/photo/U2CckbwmZV-V-vB7vSQBzdMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-a7iMyVkGw1A/U-19Qcpy-mI/AAAAAAAAFeE/A3RCfTiYk5c/s400/sIMG_3018.JPG" /></a></div>

But what to do?
The first gears started spinning when I saw I could buzz people in to the building.
I knew I would want to control this capability by more than having to physically press the button.
(FYI, this kind of door system is called an ["electric strike"](http://en.wikipedia.org/wiki/Electric_strike))

<div style="clear: both;"></div>

Tapping In
==========

<div class="left"><a href="https://picasaweb.google.com/lh/photo/2-dNoiVuupXVudRiJ8B_R9MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-L_GdzDOPc6Y/U-19QEgHcyI/AAAAAAAAFeE/-vkxnR9drdM/s400/sIMG_3019.JPG" /></a></div>

The absolute first step before I could do anything else at all would be to tap into the 'door' circuit.
I needed to get useful leads out that could be wired into some alternate system (TBD) that would trigger the buzzing-in.

Taking off the panel in the apartment didn't reveal much except for satisfying some curiosity.
But yes, shorting the two ends of the 'door' button did indeed unlock the front door.

But how would I get my leads?
Hooking in here at this point would be tricky; it was just panel and wall.
It would be difficult to hide any wires cleanly, let alone any other equipment I would need; a messy setup would not fly, especially as the first thing you see when entering the apartment.
But more important than aesthetics is safety.
Whatever controlled the door would have to be powered, and putting that kind of wiring inside a wall -- particularly a DC transformer and associated waste heat -- was not something I was comfortable with.

<div class="right">
<a href="https://picasaweb.google.com/lh/photo/4nfmQGQTyaujAD27sCIqLdMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh6.googleusercontent.com/-vCj1GsZkJxQ/U-19RQbngSI/AAAAAAAAFeE/vvxY2Hg1EOw/s400/sIMG_3026.JPG" /></a>
<div class="aside">yikes</div>
</div>

But then I realized: those wires go somewhere.
They all snake through the basement to terminate at a central console.
Access down there would be much easier.

For a while I debated how exactly to tap in to the wires down here, and even how to determine which wire was mine, lest I screw up somebody elses buzzer!

But then came my second realization: all these wires go to the same place.
The central console would provide the most straightforward access.

<div style="clear: both;"></div>
<div class="left"><a href="https://picasaweb.google.com/lh/photo/_pquxZPhPbofDR3X_vEHl9MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh3.googleusercontent.com/-McbBXUydxdk/U-19QVYUD1I/AAAAAAAAFeE/sL1X3T4XRkY/s400/sIMG_3024.JPG" /></a></div>

The entire network of buzzers in the building reduces down to these two adjacent terminals.
Just like upstairs, shorting across them unlocks the front door.

<div style="clear: both;"></div>
<div class="right"><a href="https://picasaweb.google.com/lh/photo/OUDsRZkVSII3c0MZ-d0vbNMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh3.googleusercontent.com/-gJl1S6kmZLc/U-19RZfIJYI/AAAAAAAAFeE/EQP4WGRRT34/s400/sIMG_3025.JPG" /></a></div>

So I would wire in a parallel set of leads for my own use.

This was perhaps the most nerve-wracking portion of the project.
For the few moments this step took, buzzer access was out of service for the entire building.


Phase I: Remote Control
=======================

I had the necessary electrical access.
I now needed something to take advantage of it.

<div class="right"><a href="https://picasaweb.google.com/lh/photo/qM-hDUntB-IJOm3wjy6p69MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-xydzvGZZouQ/U-19UHg_PlI/AAAAAAAAFeE/UMQ40c413v4/s400/sremote.jpg" /></a></div>

Trying to replicate the keyless entry fobs like you'd have for your car seemed like a good proof-of-concept project.

This led to investigating radio-activated relays (similar to a garage door opener) and tiny keychain remote controls.
Funnily enough, [your choice of relay](http://www.lightobject.com/Multi-function-1CH-RF-with-waterproof-remote-control-P702.aspx) ends up more than anything else being determined by your preference for the form factor of the remote that comes with it.

<div style="clear: both;"></div>
<div>
<a href="https://picasaweb.google.com/lh/photo/7tlwJQszgHkqiPKKnp0lONMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh5.googleusercontent.com/-AMvSzCCvPHI/U-19Ri6Nv5I/AAAAAAAAFeE/nSXZdGxPCSo/s400/sIMG_3030.JPG" /></a>
<div class="aside">all hooked up</div>
</div>


Phase II: Internet Control!
===========================

(obviously)

I was already immensely pleased with the radio control, but it was mostly a novelty.
Although it did save me from fishing out a key to get into the building, I still needed one to get into my apartment (no DIY [Lockitron](https://lockitron.com) just yet).
I could do more interesting things when I didn't have to be within <span style="font-family: serif;">50&#x2032;</span>.

More interesting things:

* I've locked myself out (if I don't have my keys, I definitely don't have the remote either).
* Melissa and I need to let someone in to check on something while we're away. Or, we have guests staying and wanted to avoid complicated keys hand-off.
* We're throwing a party and I don't want to man the door buzzer for three hours.

The control device presented the same issue as before: it needed access to the physical circuit.
Install a Raspberry Pi in tandem with the RF relay?
I was not thrilled with the prospect of sysadmining a glorified switch-flipper in the basement on the fringe of my wifi range.

<div class="right">
<a href="https://picasaweb.google.com/lh/photo/qC891AdTJyt2mTaU1eca6NMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh3.googleusercontent.com/-h6H4ZTJhP6w/U-19STeUBnI/AAAAAAAAFeE/k4T_Lk2taYQ/s400/sIMG_3038.JPG" /></a>
<div class="aside" style="width: 400px;">a sacrificed remote with leads wired in place of the push button; wires wrapped around the PCB for strain relief</div>
</div>

...***or***, wire up something that would trigger one of the wireless remotes, that in turn triggers the relay you've already wired up in the basement (credit Melissa for this brilliant idea).



security model. two kinds of access: resident and guest. resident access is perpetual. guest access is short-lived.


i didn't want to have to deal with whitelisting emails or phone numbers. that would get too cumbersome. i'd rather have a code and anyone with that code can use it. handles last-minute invitees to the party or someone's phone being dead. the short lifespan of the individual codes mitigates the risk. long-term/perpetual access is tied to identity. you have to be verified by your login each time.

webapp gets signal (validates it), runs a command that triggers a relay to send the radio signal. that triggers the relay to open the door.

usb relay -- product literally does not exist in the us. so instead using an arduino. which feels ridiculous. but it is nice because it ensured once the relay goes on it will always turn off too.

<div><a href="https://picasaweb.google.com/lh/photo/2WYsKxmPks5Gr-MN9hIuT9MTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh4.googleusercontent.com/-vTZoYKdJxR4/U-19S7dvz-I/AAAAAAAAFeE/IC2oC50ZGnI/s400/sIMG_3040.JPG" /></a></div>

server lives in cloud, because self-signed certs are bad. twilio won't accept them. server sends command to house server via ssh. piggybacked session.

<style>

#flowchart {
  text-align: center;
  font-family: sans-serif;
  font-size: 75%;
  float: left;
  margin-right: 2em;
}

.box {
  float: right;
  width: 10em;
  padding: .4em;
  border-radius: .3em;
  margin-bottom: 1em;
  white-space: nowrap;
}

.state {
  clear: both;
  border: 1px solid black;
}

.input {
  border: 1px solid #aaa;
  position: relative;
  width: 7em;
}

.link {
  float: right;
  padding: .4em;
  display: table-cell;
}

.link span {
  font-style: italic;
  font-size: 80%;
  color: #888;
  background-color: #eef;
  border-radius: 50%;
  display: inline-block;
}

.hlink {
  margin-left: .3em;
  margin-right: 0;
}

.vlink {
  clear: both;
  width: 10em;
  margin-top: -1em;
}

.vlink span {
  width: 8em;
}

.terminal {
  background-color: #fcc;
}
.nonterm {
	position: relative;
}
.nonterm:after, .nonterm:before {
	top: 100%;
	left: 50%;
	border: solid transparent;
	content: " ";
	height: 0;
	width: 0;
	position: absolute;
	pointer-events: none;
}

.nonterm:after {
	border-color: rgba(255, 255, 255, 0);
	border-top-color: #ffffff;
	border-width: 7px;
	margin-left: -7px;
}
.nonterm:before {
	border-color: rgba(0, 0, 0, 0);
	border-top-color: #000000;
	border-width: 8px;
	margin-left: -8px;
}

.input:after, .input:before {
	left: 100%;
	top: 50%;
	border: solid transparent;
	content: " ";
	height: 0;
	width: 0;
	position: absolute;
	pointer-events: none;
}
.input:after {
	border-color: rgba(255, 255, 255, 0);
	border-left-color: #ffffff;
	border-width: 6px;
	margin-top: -6px;
}
.input:before {
	border-color: rgba(0, 0, 0, 0);
	border-left-color: #aaa;
	border-width: 7px;
	margin-top: -7px;
}

</style>

<div id="flowchart">
  <div>
    <div class="box state nonterm">twilio gateway</div>
    <div class="link hlink"><span>SMS</span></div>
    <div class="box input">send SMS</div>
    <div class="link vlink"><span>SMS payload via HTTPS</span></div>
  </div>
  <div>
    <div class="box state nonterm">public server</div>
    <div class="link hlink"><span>HTTPS POST</span></div>
    <div class="box input">visit URL</div>
    <div class="link vlink"><span>open command via ssh</span></div>
  </div>
  <div>
    <div class="box state nonterm">on-premises server</div>
    <div class="link vlink"><span>relay trigger command via serial USB</span></div>
  </div>
  <div>
    <div class="box state nonterm">arduino controller</div>
    <div class="link vlink"><span>5V on/off signal</span></div>
  </div>
  <div>
    <div class="box state nonterm">relay board</div>
    <div class="link vlink"><span>momentary switch</span></div>
  </div>
  <div>
    <div class="box state nonterm">sacrificed remote</div>
    <div class="link vlink"><span>RF signal</span></div>
  </div>
  <div>
    <div class="box state nonterm">RF relay</div>
    <div class="link hlink"><span>RF signal</span></div>
    <div class="box input">click remote</div>
    <div class="link vlink"><span>momentary switch</span></div>
  </div>
  <div>
    <div class="box state nonterm">door console</div>
    <div class="link hlink"><span>momentary switch</span></div>
    <div class="box input">door buzzer</div>
    <div class="link vlink"><span>lock signal</span></div>
  </div>
  <div>
    <div class="box state terminal">front door!</div>
  </div>
  <div style="clear: both;"></div>
</div>

when you put it all together, it looks a bit ridiculous, rube-goldbergian:

a bit crazy to think of the thousands of miles and numerous systems my 'open' signal travels/passes through when i'm standing right in front of the door.

<div style="clear: both;"></div>

<div><a href="https://picasaweb.google.com/lh/photo/JaO6ly6QVHld4dzt2ZlJuNMTjNZETYmyPJy0liipFm0?feat=embedwebsite"><img src="https://lh4.googleusercontent.com/-_nFxoYPTH7I/U-19TrDorOI/AAAAAAAAFeE/u9zPglHtp_s/s400/sIMG_3041.JPG" /></a></div>

Security
========

as this thing grants physical access to your premises, security is important.

rf security
--------------

radio: 1527 "learning code" buzzers. 20-bit, randomly generated code.

not a "rolling code" buzzer. as i understand this would not work well for mutliple buzzers that are used with greatly differing frequency.

website
-------

ssl access (hides codes, tokens, and cookies)
url door open via signed id cookie or uuid token
uuid tokens and sms codes are short-lived
twilio access is via ssl, and requests are authenticated for origin (brute-forcing the sms codes would be relatively easy otherwise)
google authentication for admin panel

physical
--------

command is executed via ssh

code not up, but i should probably put money where my mouth is

